---
- hosts: taverna-server
  sudo: yes
  tasks:
    - name: Create Taverna Server install directory
      file: path={{taverna_server_install}} state=directory owner=tomcat6

    - name: Download Taverna Server
      get_url: url=https://biovel.googlecode.com/svn/trunk/taverna/lib/server-webapp-2.4.3.war
            dest={{taverna_server_install}}/taverna-server.war

    - name: Unpack Taverna Server
      command: unzip {{taverna_server_install}}/taverna-server.war -d {{taverna_server_install}} creates={{taverna_server_install}}/WEB-INF/web.xml

    - name: copy Taverna Server web.xml file
      copy: src=web.xml dest={{taverna_server_install}}/WEB-INF/web.xml backup=yes
      notify: Restart Tomcat

    - name: copy Taverna Server insecure.xml file
      template: src=insecure.xml.j2 dest={{taverna_server_install}}/WEB-INF/insecure.xml owner=tomcat6 mode=0600 backup=yes

    - name: copy Taverna Server properties file
      template: src=tavernaserver.properties.j2 dest={{taverna_server_install}}/WEB-INF/tavernaserver.properties backup=yes
      notify: Restart Tomcat

    - name: create Taverna Server log directory
      file: path={{taverna_server_log}} state=directory owner=tomcat6

    - name: create Taverna Server context in Tomcat
      template: src=tserver.xml.j2 dest=/etc/tomcat6/Catalina/localhost/{{taverna_server_context}}.xml owner=tomcat6
      notify: Restart Tomcat

  handlers:
    - name: Restart Tomcat
      service: name=tomcat6 state=restarted