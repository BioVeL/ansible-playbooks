---
- hosts: taverna-server
  sudo: yes
  tasks:
    - name: Create Taverna Server install directory
      file: path={{taverna_server_install}} state=directory owner=tomcat6

    - name: Download Taverna Server
      get_url: url=http://build.mygrid.org.uk/ci/job/taverna-server-2.4.3/4/uk.org.taverna.server$server-webapp/artifact/uk.org.taverna.server/server-webapp/2.4.3/server-webapp-2.4.3.war
            dest={{taverna_server_install}}/taverna-server.war

    - name: Unpack Taverna Server
      command: unzip {{taverna_server_install}}/taverna-server.war -d {{taverna_server_install}} creates={{taverna_server_install}}/WEB-INF/web.xml

    - name: copy Taverna Server web.xml file
      copy: src=web.xml dest={{taverna_server_install}}/WEB-INF/web.xml backup=yes
      notify: Restart Tomcat

    - name: copy Taverna Server insecure.xml file
      template: src=insecure.xml.j2 dest={{taverna_server_install}}/WEB-INF/insecure.xml owner=tomcat6 mode=0600 backup=yes

    - name: copy Taverna Server properties file
      template: src=tavernaserver.properties.j2 dest={{taverna_server_install}}/WEB-INF/tavernaserver.properties backup=yes
      notify: Restart Tomcat

    - name: create Taverna Server log directory
      file: path={{taverna_server_log}} state=directory owner=tomcat6

    # TODO - move JSON-simple jar installation to a BioVeL-specific section
    - name: Find Taverna Command Line lib directory
      shell: /bin/ls -d {{taverna_server_install}}/WEB-INF/classes/util/taverna-commandline-2.*/lib
      register: taverna_server_cl_lib

    - name: Install JSON-simple JAR
      get_url: url=http://json-simple.googlecode.com/files/json-simple-1.1.1.jar
          dest={{taverna_server_cl_lib.stdout}}/json-simple-1.1.1.jar

    - name: create Taverna Server context in Tomcat
      template: src=tserver.xml.j2 dest=/etc/tomcat6/Catalina/localhost/{{taverna_server_context}}.xml owner=tomcat6
      notify: Restart Tomcat

  handlers:
    - name: Restart Tomcat
      service: name=tomcat6 state=restarted