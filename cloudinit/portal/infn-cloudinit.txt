Content-Type: multipart/mixed; boundary="===============4393449873403893838=="
MIME-Version: 1.0

--===============4393449873403893838==
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#cloud-config
users:
  - name: bioveladm
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock-passwd: true
    ssh-import-id: bioveladm
    ssh-authorized-keys:
      - <your SSH public key>

--===============4393449873403893838==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="deploy.sh"

#!/bin/bash
#This script will download BioVeL Ansible playbook and setup a recipe
#for installing the BioVel Portal (test) service

#Log output for debug
echo "Logging output to /tmp/deployment.log"
exec &>/tmp/deployment.log

#Install pre-requisites
echo "Installing pre-requisites..."
apt-get update
apt-get install -y gawk git python-yaml python-jinja2 unzip curl

#Download ansible playbook
echo "Installing ansible..."
git clone https://github.com/BioVeL/ansible-playbooks
cd ansible-playbooks
source setup.sh

#Create an ansible recipe
echo "Creating ansible recipe..."
cat << EOF > inventory/hosts
[infn-ba]
test ansible_ssh_host=test.biovel.eu

[taverna-server]
test

# Rserve, accessible only to local clients
[rserve-local]
test

[biovel-portal]
test

# Do not edit below here - this provides dependencies of the above groups
[virt:children]
infn-ba

[apache-httpd:children]
biovel-portal

[apache-tomcat7:children]
taverna-server

[mysql-server:children]
biovel-portal

[ntp:children]
infn-ba

[rserve:children]
rserve-local

[rbase:children]
rserve

[external-ip:children]
biovel-portal
taverna-server

EOF

#Run ansible playbook
echo "Running ansible playbook..."
ansible-playbook -c local -i inventory/hosts playbooks/site.yaml

#Deployment completed
echo "Deployment completed"
exit 0

--===============4393449873403893838==--
